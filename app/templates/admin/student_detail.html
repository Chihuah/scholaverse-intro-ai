{% extends "base.html" %}

{% block title %}{{ student.name }} — Scholaverse{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="font-pixel text-rpg-gold text-sm sm:text-base">STUDENT DETAIL</h1>
    <a href="/admin/students" class="pixel-btn-sm">返回列表</a>
  </div>

  <!-- Student Info (Editable) -->
  <div class="pixel-panel p-4 mb-6">
    <h2 class="font-pixel text-rpg-gold text-xs mb-4">STUDENT INFO</h2>
    <form id="student-form" onsubmit="return false;">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <!-- Email (read-only) -->
        <div>
          <label class="text-rpg-text-dim text-xs block mb-1">Email</label>
          <div class="bg-rpg-bg-deep border-2 border-rpg-brass/50 text-rpg-text-dim text-sm px-3 py-2">
            {{ student.email }}
          </div>
        </div>
        <!-- Name -->
        <div>
          <label class="text-rpg-text-dim text-xs block mb-1" for="field-name">姓名</label>
          <input id="field-name" name="name" type="text" value="{{ student.name }}"
            class="w-full bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-3 py-2 focus:border-rpg-gold focus:outline-none">
        </div>
        <!-- Nickname -->
        <div>
          <label class="text-rpg-text-dim text-xs block mb-1" for="field-nickname">暱稱</label>
          <input id="field-nickname" name="nickname" type="text" value="{{ student.nickname or '' }}"
            placeholder="角色暱稱（英數字，最多18字）" maxlength="18"
            class="w-full bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-3 py-2 focus:border-rpg-gold focus:outline-none">
        </div>
        <!-- Student ID -->
        <div>
          <label class="text-rpg-text-dim text-xs block mb-1" for="field-student-id">學號</label>
          <input id="field-student-id" name="student_id" type="text" value="{{ student.student_id or '' }}"
            class="w-full bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-3 py-2 focus:border-rpg-gold focus:outline-none">
        </div>
        <!-- Role -->
        <div>
          <label class="text-rpg-text-dim text-xs block mb-1" for="field-role">角色</label>
          <select id="field-role" name="role"
            class="w-full bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-3 py-2 focus:border-rpg-gold focus:outline-none">
            <option value="student" {{ 'selected' if student.role == 'student' }}>student</option>
            <option value="teacher" {{ 'selected' if student.role == 'teacher' }}>teacher</option>
            <option value="admin" {{ 'selected' if student.role == 'admin' }}>admin</option>
          </select>
        </div>
        <!-- Tokens -->
        <div>
          <label class="text-rpg-text-dim text-xs block mb-1" for="field-tokens">代幣</label>
          <input id="field-tokens" name="tokens" type="number" value="{{ student.tokens }}" min="0"
            class="w-full bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-3 py-2 focus:border-rpg-gold focus:outline-none">
        </div>
      </div>
      <div class="mt-4 flex justify-end">
        <button type="button" onclick="saveStudent()" class="pixel-btn pixel-btn-gold">儲存變更</button>
      </div>
    </form>
    <p class="text-rpg-text-dim text-xs mt-3">
      註冊於 {{ student.created_at.strftime('%Y-%m-%d') if student.created_at else '—' }}
    </p>
  </div>

  <!-- Learning Records (Editable) -->
  <div class="pixel-panel p-4 mb-6">
    <h2 class="font-pixel text-rpg-gold text-xs mb-4">LEARNING RECORDS</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b-2 border-rpg-brass text-rpg-text-dim text-xs">
            <th class="text-left py-2 px-2">單元</th>
            <th class="text-right py-2 px-2">預習</th>
            <th class="text-right py-2 px-2">測驗</th>
            <th class="text-right py-2 px-2">作業</th>
            <th class="text-right py-2 px-2">完成率</th>
            <th class="text-center py-2 px-2"></th>
          </tr>
        </thead>
        <tbody>
          {% for unit in units %}
          {% set rec = records_by_unit.get(unit.id) %}
          <tr class="border-b border-rpg-brass/30" id="record-row-{{ unit.id }}">
            <td class="py-2 px-2 whitespace-nowrap">
              <span class="text-rpg-gold">{{ unit.code }}</span>
              <span class="text-rpg-text-dim ml-1">{{ unit.name }}</span>
            </td>
            <td class="text-right py-2 px-1">
              <input type="number" step="0.1" min="0" max="100"
                id="preview-{{ unit.id }}" value="{{ rec.preview_score if rec and rec.preview_score is not none else '' }}"
                class="w-16 bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-2 py-1 text-right focus:border-rpg-gold focus:outline-none">
            </td>
            <td class="text-right py-2 px-1">
              <input type="number" step="0.1" min="0" max="100"
                id="quiz-{{ unit.id }}" value="{{ rec.quiz_score if rec and rec.quiz_score is not none else '' }}"
                class="w-16 bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-2 py-1 text-right focus:border-rpg-gold focus:outline-none">
            </td>
            <td class="text-right py-2 px-1">
              <input type="number" step="0.1" min="0" max="100"
                id="homework-{{ unit.id }}" value="{{ rec.homework_score if rec and rec.homework_score is not none else '' }}"
                class="w-16 bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-2 py-1 text-right focus:border-rpg-gold focus:outline-none">
            </td>
            <td class="text-right py-2 px-1">
              <input type="number" step="0.1" min="0" max="100"
                id="completion-{{ unit.id }}" value="{{ rec.completion_rate if rec and rec.completion_rate is not none else '' }}"
                class="w-16 bg-rpg-bg-deep border-2 border-rpg-brass text-rpg-text text-sm px-2 py-1 text-right focus:border-rpg-gold focus:outline-none">
            </td>
            <td class="text-center py-2 px-1">
              <button type="button" onclick="saveRecord({{ unit.id }})" class="pixel-btn-sm">儲存</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Cards (Read-only) -->
  <div class="pixel-panel p-4 mb-6">
    <h2 class="font-pixel text-rpg-gold text-xs mb-4">CARDS ({{ cards | length }})</h2>
    {% if cards %}
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      {% for card in cards %}
      <div class="bg-rpg-bg border border-rpg-brass p-3 text-sm">
        <div class="flex justify-between items-start">
          <span class="text-rpg-gold">#{{ card.id }}</span>
          <span class="text-xs px-2 py-0.5 border
            {% if card.status == 'completed' %}border-green-600 text-green-400
            {% elif card.status == 'generating' %}border-yellow-600 text-yellow-400
            {% elif card.status == 'failed' %}border-red-600 text-red-400
            {% else %}border-rpg-brass text-rpg-text-dim{% endif %}">
            {{ card.status }}
          </span>
        </div>
        <p class="text-rpg-text-dim text-xs mt-1">
          {{ card.created_at.strftime('%Y-%m-%d %H:%M') if card.created_at else '—' }}
          {% if card.is_latest %}<span class="text-rpg-gold ml-1">★ latest</span>{% endif %}
        </p>
        {% if card.border_style %}
        <p class="text-xs mt-1">Border: {{ card.border_style }} ・ Lv.{{ card.level_number or '?' }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-rpg-text-dim text-sm">尚無卡牌。</p>
    {% endif %}
  </div>

  <!-- Unbind Section -->
  <div class="pixel-panel p-4 mb-6" style="border-color: #ef4444; box-shadow: -4px 0 0 0 #ef4444, 4px 0 0 0 #ef4444, 0 -4px 0 0 #ef4444, 0 4px 0 0 #ef4444, -8px 0 0 0 #991b1b, 8px 0 0 0 #991b1b, 0 -8px 0 0 #991b1b, 0 8px 0 0 #991b1b, inset 0 0 0 2px rgba(0,0,0,0.4), inset 0 0 12px rgba(0,0,0,0.3);">
    <h2 class="font-pixel text-red-400 text-xs mb-3">DANGER ZONE</h2>
    <p class="text-rpg-text-dim text-sm mb-4">
      解除此帳號的 Email 綁定後，該 Gmail 帳號下次登入將需要重新自助註冊。學生的學習記錄與卡牌資料將會保留。
    </p>
    <button type="button" onclick="unbindStudent()"
      class="bg-red-900/30 border-2 border-red-500 text-red-400 px-4 py-2 hover:bg-red-900/50 cursor-pointer text-sm font-semibold">
      解除綁定
    </button>
  </div>
</div>

<script>
const STUDENT_ID = {{ student.id }};

async function saveStudent() {
  const payload = {
    name: document.getElementById('field-name').value,
    nickname: document.getElementById('field-nickname').value,
    student_id: document.getElementById('field-student-id').value,
    role: document.getElementById('field-role').value,
    tokens: parseInt(document.getElementById('field-tokens').value, 10) || 0,
  };
  try {
    const res = await fetch(`/api/admin/students/${STUDENT_ID}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) {
      showToast(data.detail || '儲存失敗', 'error');
      return;
    }
    showToast('學生資料已更新', 'success');
  } catch (e) {
    showToast('請求失敗', 'error');
  }
}

async function saveRecord(unitId) {
  const val = (id) => {
    const el = document.getElementById(id);
    return el && el.value !== '' ? parseFloat(el.value) : null;
  };
  const payload = {
    preview_score: val(`preview-${unitId}`),
    quiz_score: val(`quiz-${unitId}`),
    homework_score: val(`homework-${unitId}`),
    completion_rate: val(`completion-${unitId}`),
  };
  try {
    const res = await fetch(`/api/admin/students/${STUDENT_ID}/records/${unitId}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) {
      showToast(data.detail || '儲存失敗', 'error');
      return;
    }
    showToast('成績已更新', 'success');
  } catch (e) {
    showToast('請求失敗', 'error');
  }
}

async function unbindStudent() {
  if (!confirm('確定要解除此學生的 Email 綁定嗎？學習記錄與卡牌資料將會保留。')) return;
  try {
    const res = await fetch(`/api/admin/students/${STUDENT_ID}/unbind`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
    });
    const data = await res.json();
    if (!res.ok) {
      showToast(data.detail || '操作失敗', 'error');
      return;
    }
    showToast(data.message || '已解除綁定', 'success');
    setTimeout(() => { window.location.href = '/admin/students'; }, 1000);
  } catch (e) {
    showToast('請求失敗', 'error');
  }
}
</script>
{% endblock %}
