{% extends "base.html" %}

{% block title %}Scholaverse - 學習歷程{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="pixel-title text-lg sm:text-xl mb-2">我的學習歷程</h1>
  <p class="text-rpg-text-dim text-sm">各單元學習成績與角色屬性解鎖進度</p>
</div>

{% for item in unit_data %}
{% set u = item.unit %}
{% set record = item.record %}
{% set rate = item.rate %}

<div class="pixel-panel mb-6">
  <!-- Unit Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
    <div>
      <h2 class="pixel-title text-xs">{{ u.name }}</h2>
      <p class="text-rpg-text-dim text-xs mt-1">
        第 {{ u.week_start }}~{{ u.week_end }} 週
        &middot;
        解鎖: {{ item.attr_label }}
      </p>
    </div>
    <div>
      {% if item.status == "completed" %}
      <span class="inline-block px-3 py-1 text-xs font-semibold bg-green-900/50 text-green-400 border-2 border-green-600">已完成</span>
      {% elif item.status == "in_progress" %}
      <span class="inline-block px-3 py-1 text-xs font-semibold bg-yellow-900/50 text-yellow-400 border-2 border-yellow-600">進行中</span>
      {% else %}
      <span class="inline-block px-3 py-1 text-xs font-semibold bg-gray-900/50 text-gray-400 border-2 border-gray-600">未解鎖</span>
      {% endif %}
    </div>
  </div>

  {% if record %}
  <!-- Scores Grid -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
    <div class="bg-rpg-bg-deep p-3 border-2 border-rpg-brass text-center">
      <p class="text-rpg-text-dim text-xs mb-1">預習評分</p>
      <p class="font-mono text-lg font-bold {% if record.preview_score is not none and record.preview_score >= 75 %}text-green-400{% elif record.preview_score is not none and record.preview_score >= 40 %}text-yellow-400{% elif record.preview_score is not none %}text-red-400{% else %}text-rpg-text-dim{% endif %}">
        {{ record.preview_score | round(0) | int if record.preview_score is not none else '--' }}
      </p>
    </div>
    <div class="bg-rpg-bg-deep p-3 border-2 border-rpg-brass text-center">
      <p class="text-rpg-text-dim text-xs mb-1">隨堂測驗</p>
      <p class="font-mono text-lg font-bold {% if record.quiz_score is not none and record.quiz_score >= 75 %}text-green-400{% elif record.quiz_score is not none and record.quiz_score >= 40 %}text-yellow-400{% elif record.quiz_score is not none %}text-red-400{% else %}text-rpg-text-dim{% endif %}">
        {{ record.quiz_score | round(0) | int if record.quiz_score is not none else '--' }}
      </p>
    </div>
    <div class="bg-rpg-bg-deep p-3 border-2 border-rpg-brass text-center">
      <p class="text-rpg-text-dim text-xs mb-1">課後練習</p>
      <p class="font-mono text-lg font-bold {% if record.homework_score is not none and record.homework_score >= 75 %}text-green-400{% elif record.homework_score is not none and record.homework_score >= 40 %}text-yellow-400{% elif record.homework_score is not none %}text-red-400{% else %}text-rpg-text-dim{% endif %}">
        {{ record.homework_score | round(0) | int if record.homework_score is not none else '--' }}
      </p>
    </div>
    <div class="bg-rpg-bg-deep p-3 border-2 border-rpg-brass text-center">
      <p class="text-rpg-text-dim text-xs mb-1">完成度</p>
      <p class="font-mono text-lg font-bold text-rpg-gold">{{ rate | round(0) | int }}%</p>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="rpg-progress-bar mb-4">
    {% if rate >= 80 %}
    <div class="bar-fill" style="width: {{ rate }}%;"></div>
    {% elif rate >= 40 %}
    <div class="bar-fill bar-warning" style="width: {{ rate }}%;"></div>
    {% else %}
    <div class="bar-fill bar-danger" style="width: {{ rate }}%;"></div>
    {% endif %}
  </div>

  <!-- Unlocked Attributes Summary -->
  {% if item.available %}
  <div class="mb-4">
    <p class="text-sm font-semibold text-rpg-text mb-2">解鎖屬性:</p>
    <div class="flex flex-wrap gap-2">
      {% for attr_name, attr_data in item.available.items() %}
      <span class="inline-block px-3 py-1 text-xs border-2
        {% if item.chosen_attrs.get(attr_name) %}
          bg-rpg-panel-alt border-rpg-gold text-rpg-gold
        {% else %}
          bg-rpg-bg border-rpg-brass text-rpg-text-dim
        {% endif %}">
        {% if item.chosen_attrs.get(attr_name) %}
          {{ attr_data.labels.get(item.chosen_attrs[attr_name], item.chosen_attrs[attr_name]) }}
        {% else %}
          {{ attr_name }}: {{ attr_data.options | length }} 項可選
        {% endif %}
      </span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Action -->
  <div class="flex justify-end">
    <a href="/progress/{{ u.code }}" class="pixel-btn text-xs">查看 / 修改配置</a>
  </div>

  {% else %}
  <!-- Locked State -->
  <div class="text-center py-6">
    <p class="text-rpg-text-dim text-sm">尚無學習紀錄，待教師匯入成績後將自動解鎖。</p>
    <div class="rpg-progress-bar mt-3 max-w-md mx-auto">
      <div class="bar-fill bar-locked" style="width: 0%;"></div>
    </div>
  </div>
  {% endif %}
</div>
{% endfor %}

{% if not unit_data %}
<div class="pixel-panel">
  <p class="text-rpg-text-dim text-sm text-center py-6">尚無學習單元資料。</p>
</div>
{% endif %}
{% endblock %}
