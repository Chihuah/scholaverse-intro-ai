{% extends "base.html" %}

{% block title %}Scholaverse - å„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="pixel-title text-lg sm:text-xl mb-2">å„€è¡¨æ¿</h1>
  <p class="text-rpg-text-dim text-sm">
    {% if user %}æ­¡è¿å›ä¾†ï¼Œ{{ user.name | default('å†’éšªè€…') }}ï¼{% else %}æ­¡è¿ä¾†åˆ° Scholaverse{% endif %}
  </p>
</div>

<!-- Dashboard Grid: Character Preview + Learning Progress -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

  <!-- Character Preview Panel -->
  <div class="pixel-panel">
    <h2 class="pixel-title text-xs mb-4">è§’è‰²é è¦½</h2>
    <div class="flex flex-col items-center gap-4">
      {% if latest_card and latest_card.image_url %}
      <div class="card-frame card-frame-{{ latest_card.border_style | default('copper') }} w-48 h-64 flex items-center justify-center overflow-hidden">
        <img src="{{ latest_card.image_url }}" alt="è§’è‰²å¡ç‰Œ"
             class="w-full h-full object-cover" style="image-rendering: pixelated;">
      </div>
      <div class="text-center">
        <p class="text-rpg-gold font-semibold text-sm">
          Lv.{{ latest_card.level_number | default('--') }}
          {% if latest_card.config_snapshot %}
            {% set config = latest_card.config_snapshot | tojson | default('{}') %}
          {% endif %}
        </p>
        <p class="text-rpg-text-dim text-xs mt-1">
          <a href="/cards/{{ latest_card.id }}" class="text-rpg-gold hover:underline">æŸ¥çœ‹å¡ç‰Œè©³æƒ…</a>
        </p>
      </div>
      {% else %}
      <div class="card-frame card-frame-copper w-48 h-64 flex items-center justify-center bg-rpg-bg-deep">
        <div class="text-center">
          <div class="text-rpg-text-dim text-4xl mb-2">?</div>
          <p class="text-rpg-text-dim text-xs">å°šæœªç”Ÿæˆå¡ç‰Œ</p>
        </div>
      </div>
      <div class="text-center">
        <p class="text-rpg-text-dim text-sm">Lv.-- ------</p>
        <p class="text-rpg-text-dim text-xs mt-1">å®Œæˆå­¸ç¿’å–®å…ƒä»¥è§£é–è§’è‰²å±¬æ€§</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Learning Progress Panel -->
  <div class="pixel-panel">
    <h2 class="pixel-title text-xs mb-4">å­¸ç¿’é€²åº¦</h2>
    <div class="flex flex-col gap-4">
      {% for unit in units %}
      {% set record = records_by_unit.get(unit.id) %}
      {% set rate = record.completion_rate | default(0) if record else 0 %}
      <div>
        <div class="flex justify-between items-baseline mb-1">
          <span class="text-sm font-semibold">{{ unit.name }}</span>
          <span class="text-xs text-rpg-text-dim">{{ unit.unlock_attribute }}</span>
        </div>
        <div class="rpg-progress-bar">
          {% if record %}
            {% if rate >= 80 %}
          <div class="bar-fill" style="width: {{ rate }}%;"></div>
            {% elif rate >= 40 %}
          <div class="bar-fill bar-warning" style="width: {{ rate }}%;"></div>
            {% else %}
          <div class="bar-fill bar-danger" style="width: {{ rate }}%;"></div>
            {% endif %}
          {% else %}
          <div class="bar-fill bar-locked" style="width: 0%;"></div>
          {% endif %}
        </div>
        <div class="text-right mt-1">
          {% if record %}
          <span class="text-xs text-rpg-text-dim font-mono">{{ rate | round(0) | int }} / 100</span>
          {% else %}
          <span class="text-xs text-rpg-text-dim font-mono">ğŸ”’ æœªè§£é–</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      {% if not units %}
      <p class="text-rpg-text-dim text-sm">å°šç„¡å­¸ç¿’å–®å…ƒè³‡æ–™ã€‚</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Divider -->
<div class="pixel-divider" aria-hidden="true"></div>

<!-- Quick Actions -->
<div class="pixel-panel mb-6">
  <h2 class="pixel-title text-xs mb-4">å¿«é€Ÿæ“ä½œ</h2>
  <div class="flex flex-wrap gap-4">
    <a href="/cards" class="pixel-btn">æˆ‘çš„å¡ç‰Œ</a>
    <a href="/hall" class="pixel-btn">è§’è‰²å¤§å»³</a>
    <a href="/progress" class="pixel-btn">å­¸ç¿’æ­·ç¨‹</a>
    {% if user and user.role in ['teacher', 'admin'] %}
    <a href="/admin" class="pixel-btn pixel-btn-gold">ç®¡ç†å¾Œå°</a>
    {% endif %}
  </div>
</div>

<!-- Divider -->
<div class="pixel-divider" aria-hidden="true"></div>

<!-- Token Balance -->
<div class="pixel-panel">
  <div class="flex items-center gap-3">
    <h2 class="pixel-title text-xs">ä»£å¹£é¤˜é¡</h2>
    <span class="token-badge text-lg">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor">
        <circle cx="8" cy="8" r="7" fill="#ffd700" stroke="#8b6914" stroke-width="1"/>
        <text x="8" y="11" text-anchor="middle" font-size="8" fill="#8b6914" font-weight="bold">$</text>
      </svg>
      {% if user %}{{ user.tokens | default(0) }}{% else %}0{% endif %}
    </span>
  </div>
  <p class="text-rpg-text-dim text-xs mt-2">
    å®Œæˆå•å·èˆ‡ç·´ç¿’å¯ç²å¾—ä»£å¹£ï¼Œç”¨æ–¼é‡æ–°ç”Ÿæˆå¡ç‰Œæˆ–ä¿®æ”¹è§’è‰²é…ç½®ã€‚
  </p>
</div>
{% endblock %}
